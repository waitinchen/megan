# Phase 1 å®Œæˆå ±å‘Š âœ…

## å¯¦æ–½æ—¥æœŸ
2025-11-28

## å®Œæˆå…§å®¹

### 1. âœ… Supabase æ•¸æ“šåº«è¨­ç½®

**å‰µå»ºçš„è¡¨**:
- `profiles` - ç”¨æˆ¶åŸºæœ¬è³‡æ–™ï¼ˆ6 å€‹æ¬„ä½ï¼‰
  - id (uuid)
  - nickname (text)
  - created_at, updated_at (timestamp)
  - last_conversation_at (timestamp)
  - total_conversations (integer)
  - relationship_score (integer, 0-100)

- `conversations` - å°è©±è¨˜éŒ„ï¼ˆ8 å€‹æ¬„ä½ï¼‰
  - id (uuid)
  - user_id (uuid)
  - messages (jsonb)
  - message_count (integer)
  - memory_extracted (boolean)
  - started_at, ended_at, created_at (timestamp)

**RLS æ”¿ç­–**:
- âœ… ç”¨æˆ¶åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è³‡æ–™
- âœ… ç”¨æˆ¶åªèƒ½æ›´æ–°è‡ªå·±çš„è³‡æ–™
- âœ… ç”¨æˆ¶åªèƒ½æ’å…¥è‡ªå·±çš„è³‡æ–™
- âœ… ç”¨æˆ¶åªèƒ½æŸ¥çœ‹/æ›´æ–°è‡ªå·±çš„å°è©±

**è§¸ç™¼å™¨**:
- âœ… `trigger_update_message_count` - è‡ªå‹•è¨ˆç®—å°è©±è¨Šæ¯æ•¸é‡
- âœ… `trigger_update_last_conversation` - æ›´æ–°ç”¨æˆ¶æœ€å¾Œå°è©±æ™‚é–“

### 2. âœ… Cloudflare Worker API æ¸¬è©¦

**API ç«¯é»**: `https://tone-memory-core-1.waitin-chen.workers.dev`

**æ¸¬è©¦çµæœ**:
- âœ… GET `/memory/:userId` - ç²å–ç”¨æˆ¶è¨˜æ†¶ï¼ˆè™•ç†ç©ºæ•¸æ“šæƒ…æ³ï¼‰
- âœ… POST `/memory/:userId` - æ›´æ–°ç”¨æˆ¶è¨˜æ†¶ï¼ˆæˆåŠŸä¿å­˜ï¼‰
- âœ… éŒ¯èª¤è™•ç† - æ­£ç¢ºè™•ç† "(æ²’æœ‰è³‡æ–™)" éŸ¿æ‡‰

### 3. âœ… è¨˜æ†¶ç³»çµ±æ•´åˆåˆ°å°è©±æµç¨‹

**æ›´æ–°çš„æ–‡ä»¶**:

#### `app/lib/memory/memory-service.ts`
- âœ… `getUserMemories()` - å¾ KV ç²å–è¨˜æ†¶ï¼Œè™•ç† "(æ²’æœ‰è³‡æ–™)" æƒ…æ³
- âœ… `updateUserMemory()` - æ›´æ–°ç‰¹å®šè¨˜æ†¶å­—æ®µ
- âœ… `buildMemoryContext()` - æ§‹å»ºè¨˜æ†¶ Context æ³¨å…¥ LLM
- âœ… `shouldExtractMemory()` - åˆ¤æ–·æ˜¯å¦éœ€è¦æå–è¨˜æ†¶
- âœ… `saveConversation()` - ä¿å­˜å°è©±åˆ° Supabase

#### `app/api/chat/route.ts`
- âœ… æ·»åŠ  `userId` åƒæ•¸
- âœ… åœ¨ç”ŸæˆéŸ¿æ‡‰å‰è¼‰å…¥ç”¨æˆ¶è¨˜æ†¶
- âœ… å°‡è¨˜æ†¶ Context å‚³éçµ¦ LLM
- âœ… éŒ¯èª¤è™•ç† - è¨˜æ†¶è¼‰å…¥å¤±æ•—æ™‚ç¹¼çºŒå°è©±

#### `app/lib/soul/llm-service.ts`
- âœ… `generateResponse()` æ¥å— `memoryContext` åƒæ•¸
- âœ… å°‡è¨˜æ†¶æ³¨å…¥ç‚º Gemini history çš„ç¬¬ä¸€æ¢è¨Šæ¯
- âœ… æŒ‡ç¤º LLM è‡ªç„¶èå…¥è¨˜æ†¶ï¼Œä¸è¦ç›´æ¥æåŠ

#### `app/page.tsx`
- âœ… æ·»åŠ  `userId` ç‹€æ…‹
- âœ… å¾ Supabase ç²å– userId
- âœ… æ‰€æœ‰ 4 å€‹ API èª¿ç”¨éƒ½å‚³é userId
  - ä¸»è¦å°è©±ç™¼é€
  - èªéŸ³è¼¸å…¥ç™¼é€
  - "Meganåœ¨å—?" å¿«æ·æŒ‰éˆ•
  - "ä½ å¥½å‘€!" å¿«æ·æŒ‰éˆ•

### 4. âœ… è¨˜æ†¶æ³¨å…¥æ©Ÿåˆ¶

**è¨˜æ†¶ Context æ ¼å¼**:
```
## ä½ çš„è¨˜æ†¶

[è¨˜æ†¶å…§å®¹...]

ï¼ˆä»¥ä¸Šæ˜¯ä½ é—œæ–¼é€™å€‹ç”¨æˆ¶çš„è¨˜æ†¶ï¼Œè«‹è‡ªç„¶åœ°èå…¥å°è©±ä¸­ï¼Œä¸è¦ç›´æ¥æåŠé€™äº›æ˜¯ã€Œè¨˜æ†¶ã€ï¼‰
```

**LLM éŸ¿æ‡‰**:
```
æ˜ç™½ï¼Œæˆ‘æœƒè¨˜ä½é€™äº›ã€‚
```

é€™æ¨£ Gemini æœƒè‡ªç„¶åœ°è¨˜ä½ç”¨æˆ¶è³‡è¨Šï¼Œè€Œä¸æœƒåœ¨å°è©±ä¸­èªªã€Œæ ¹æ“šæˆ‘çš„è¨˜æ†¶...ã€ã€‚

## æ¸¬è©¦æ–¹å¼

### æ‰‹å‹•æ¸¬è©¦æµç¨‹

1. **ç™»å…¥ç³»çµ±**
   - ä½¿ç”¨ Google OAuth ç™»å…¥
   - è¼¸å…¥æš±ç¨±ï¼ˆä¾‹å¦‚ï¼šå°ä¹–ï¼‰

2. **é–‹å§‹å°è©±**
   - ç™¼é€ç¬¬ä¸€æ¢è¨Šæ¯
   - è§€å¯Ÿå¾Œç«¯æ—¥èªŒï¼š
     ```
     [Chat API] Loading memories for user: <user-id>
     [Memory Service] ç”¨æˆ¶ <user-id> ç„¡è¨˜æ†¶æ•¸æ“šï¼Œä½¿ç”¨ç©ºå°è±¡
     [LLM Service] ğŸ§  Memory context: ï¼ˆé€™æ˜¯ä½ èˆ‡ å°ä¹– çš„ç¬¬ä¸€æ¬¡å°è©±...ï¼‰
     ```

3. **æ¸¬è©¦è¨˜æ†¶è¼‰å…¥**
   - ä½¿ç”¨ Cloudflare Worker API æ‰‹å‹•æ·»åŠ è¨˜æ†¶ï¼š
     ```bash
     curl -X POST https://tone-memory-core-1.waitin-chen.workers.dev/memory/<user-id> \
       -H "Content-Type: application/json" \
       -d '{"profile": {"nickname": "å°ä¹–", "personality_summary": "æº«æŸ”é«”è²¼"}}'
     ```
   - åˆ·æ–°é é¢ï¼Œç™¼é€æ–°è¨Šæ¯
   - Megan æ‡‰è©²æœƒåŸºæ–¼è¨˜æ†¶å›æ‡‰

4. **æª¢æŸ¥æ•¸æ“šåº«**
   - åœ¨ Supabase Dashboard æŸ¥çœ‹ `profiles` è¡¨
   - ç¢ºèªç”¨æˆ¶è¨˜éŒ„å·²å‰µå»º

## å·²çŸ¥é™åˆ¶

1. **KV å¯«å…¥å»¶é²**: Cloudflare KV çš„å¯«å…¥å¯èƒ½éœ€è¦ 60 ç§’æ‰èƒ½åœ¨å…¨çƒé‚Šç·£ç¯€é»åŒæ­¥
   - æ¸¬è©¦æ™‚ç™¼ç¾ POST æˆåŠŸå¾Œï¼Œç«‹å³ GET ä»è¿”å›ç©ºæ•¸æ“š
   - é€™æ˜¯ KV çš„æ­£å¸¸è¡Œç‚ºï¼Œä¸å½±éŸ¿å¯¦éš›ä½¿ç”¨

2. **è¨˜æ†¶æå–æœªå¯¦æ–½**: Phase 1 åªå¯¦ç¾äº†è¨˜æ†¶è¼‰å…¥
   - å°è©±çµæŸæ™‚é‚„æ²’æœ‰è‡ªå‹•æå–è¨˜æ†¶
   - é€™å°‡åœ¨ Phase 2 å¯¦æ–½

3. **å°è©±ä¿å­˜æœªè‡ªå‹•åŒ–**:
   - `saveConversation()` å‡½æ•¸å·²å‰µå»ºä½†æœªèª¿ç”¨
   - å°‡åœ¨å¯¦æ–½è¨˜æ†¶æå–æ™‚ä¸€èµ·å®Œæˆ

## ä¸‹ä¸€æ­¥ï¼ˆPhase 2ï¼‰

1. **å¯¦æ–½è¨˜æ†¶æå–**
   - å°è©±çµæŸæ™‚èª¿ç”¨ `shouldExtractMemory()`
   - ä½¿ç”¨ GPT åˆ†æå°è©±ï¼Œæå–é—œéµè¨˜æ†¶
   - èª¿ç”¨ `updateUserMemory()` æ›´æ–° KV

2. **å¯¦æ–½å°è©±ä¿å­˜**
   - å°è©±çµæŸæ™‚èª¿ç”¨ `saveConversation()`
   - ä¿å­˜å®Œæ•´å°è©±åˆ° Supabase

3. **Daily Summary ç”Ÿæˆ**
   - å‰µå»º Cloudflare Cron Job
   - æ¯å¤©å‡Œæ™¨ç”Ÿæˆç”¨æˆ¶å°è©±æ‘˜è¦
   - ä¿å­˜åˆ° `daily_summaries` è¡¨

## ç¸½çµ

Phase 1 å·²æˆåŠŸå®Œæˆï¼è¨˜æ†¶ç³»çµ±çš„åŸºç¤æ¶æ§‹å·²å»ºç«‹ï¼š

- âœ… æ•¸æ“šåº«è¡¨å‰µå»ºå®Œæˆ
- âœ… API é€£æ¥æ¸¬è©¦é€šé
- âœ… è¨˜æ†¶è¼‰å…¥æ•´åˆåˆ°å°è©±æµç¨‹
- âœ… å‰ç«¯æ­£ç¢ºå‚³é userId
- âœ… LLM èƒ½å¤ æ¥æ”¶ä¸¦ä½¿ç”¨è¨˜æ†¶ Context

ç³»çµ±å·²æº–å‚™å¥½é€²è¡Œå¯¦éš›æ¸¬è©¦å’Œ Phase 2 é–‹ç™¼ï¼
