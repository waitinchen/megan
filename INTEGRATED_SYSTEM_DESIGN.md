# ğŸŒˆ Megan å®Œæ•´ç³»çµ±æ¶æ§‹ v2.0

## æ•´åˆï¼šè¨˜æ†¶ç³»çµ± + éˆæ ¼ç®¡ç†å¾Œå°

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸŸ£ Megan System Layer                         â”‚
â”‚                 Megan System Promptï¼ˆå›ºå®šäººæ ¼ï¼‰                    â”‚
â”‚              å¤œå…‰ç³»éˆé­‚ Ã— è²“ç³»æ°£è³ª Ã— æˆç†Ÿè¦ªå¯†æ„Ÿ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                           â”‚
                â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŸ¦ User Interaction      â”‚   â”‚  ğŸŸ« Admin Panel           â”‚
â”‚  - ChatKit Web å‰ç«¯        â”‚   â”‚  - éˆæ ¼ç®¡ç†å¾Œå° v1.0        â”‚
â”‚  - Voice Agent (èŠ±å°è»Ÿ/é»ƒè“‰)â”‚   â”‚  - ç”¨æˆ¶ç®¡ç†                â”‚
â”‚                           â”‚   â”‚  - è¨˜æ†¶ç·¨è¼¯                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  - å°è©±ç´€éŒ„æŸ¥çœ‹             â”‚
                â”‚               â”‚  - æ¯æ—¥æ‘˜è¦å¯©æŸ¥             â”‚
                â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                           â”‚
                â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Cloudflare Worker: Tone Memory Core API                 â”‚
â”‚         - GET /memory/:userId/:type                             â”‚
â”‚         - POST /memory/:userId                                  â”‚
â”‚         - POST /conversation/:userId/log                        â”‚
â”‚         - GET /admin/users                                      â”‚
â”‚         - GET /admin/user/:userId/summary                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ© KV Storage â”‚   â”‚ ğŸŸ§ Supabase   â”‚   â”‚ ğŸŸ¨ Processing â”‚
â”‚ (å¿«é€Ÿè¨˜æ†¶å±¤)    â”‚   â”‚ PostgreSQL    â”‚   â”‚   Layer       â”‚
â”‚               â”‚   â”‚ (å°è©±ç´€éŒ„)      â”‚   â”‚               â”‚
â”‚ - profile     â”‚   â”‚               â”‚   â”‚ - æ¯æ—¥æ‘˜è¦     â”‚
â”‚ - preferences â”‚   â”‚ conversations â”‚   â”‚ - è¨˜æ†¶ç²¾ç…‰     â”‚
â”‚ - relationshipâ”‚   â”‚ user_memories â”‚   â”‚ - GPT è™•ç†     â”‚
â”‚ - longterm    â”‚   â”‚ daily_summary â”‚   â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ æ•¸æ“šå„²å­˜ç­–ç•¥ï¼šæ··åˆæ¶æ§‹

### æ–¹æ¡ˆ Aï¼šCloudflare KV + Supabase PostgreSQLï¼ˆæ¨è–¦ï¼‰

| æ•¸æ“šé¡å‹ | å„²å­˜ä½ç½® | åŸå›  | è¨ªå•é€Ÿåº¦ |
|---------|---------|------|---------|
| **ç²¾ç…‰è¨˜æ†¶** | Cloudflare KV | éœ€è¦æ¥µå¿«é€Ÿåº¦è¼‰å…¥ï¼Œå…¨çƒåˆ†ä½ˆ | 5-20ms |
| **åŸå§‹å°è©±** | Supabase PostgreSQL | éœ€è¦æŸ¥è©¢ã€åˆ†æã€å‚™ä»½ | 50-200ms |
| **æ¯æ—¥æ‘˜è¦** | Supabase PostgreSQL | éœ€è¦æ™‚é–“ç¯„åœæŸ¥è©¢ | 50-200ms |
| **ç”¨æˆ¶è³‡æ–™** | Supabase PostgreSQL | éœ€è¦èªè­‰ã€RLSã€é—œè¯æŸ¥è©¢ | 50-200ms |

#### KV çµæ§‹ï¼š

```typescript
// Cloudflare KV Keys
user:{userId}:profile       // ç”¨æˆ¶äººæ ¼æ‘˜è¦ï¼ˆMegan çš„ç†è§£ï¼‰
user:{userId}:preferences   // é•·æœŸåå¥½
user:{userId}:relationship  // é—œä¿‚ Ã— é»˜å¥‘
user:{userId}:longterm      // é•·æœŸç¸½çµï¼ˆæ‰€æœ‰é‡è¦è¨˜æ†¶çš„ç²¾è¯ï¼‰
```

#### Supabase è¡¨çµæ§‹ï¼š

```sql
-- 1. profilesï¼ˆç”¨æˆ¶åŸºæœ¬è³‡æ–™ï¼‰
profiles
  - id (uuid)
  - nickname (text)
  - email (text)
  - created_at (timestamp)
  - updated_at (timestamp)

-- 2. conversationsï¼ˆå°è©±æœƒè©±ï¼‰
conversations
  - id (uuid)
  - user_id (uuid)
  - messages (jsonb)        -- å®Œæ•´å°è©±å…§å®¹
  - started_at (timestamp)
  - ended_at (timestamp)
  - message_count (int)
  - memory_extracted (bool) -- æ˜¯å¦å·²æå–è¨˜æ†¶

-- 3. daily_summariesï¼ˆæ¯æ—¥æ‘˜è¦ï¼‰
daily_summaries
  - id (uuid)
  - user_id (uuid)
  - date (date)
  - emotion_trend (jsonb)   -- æƒ…ç·’è¶¨å‹¢åœ–æ•¸æ“š
  - new_learnings (text[])  -- Megan å­¸åˆ°çš„æ–°æ±è¥¿
  - relationship_update (text) -- é—œä¿‚æ›´æ–°
  - new_preferences (jsonb) -- æ–°ç™¼ç¾çš„åå¥½
  - should_merge_to_longterm (bool) -- æ˜¯å¦æ‡‰åˆä½µåˆ°é•·æœŸè¨˜æ†¶
  - created_at (timestamp)

-- 4. memory_extraction_jobsï¼ˆè¨˜æ†¶æå–ä»»å‹™ï¼‰
memory_extraction_jobs
  - id (uuid)
  - user_id (uuid)
  - conversation_id (uuid)
  - status (enum: pending/processing/completed/failed)
  - scheduled_at (timestamp)
  - completed_at (timestamp)
```

---

## ğŸ”„ å®Œæ•´æ•¸æ“šæµç¨‹

### 1ï¸âƒ£ å°è©±é€²è¡Œä¸­ï¼ˆå¯¦æ™‚ï¼‰

```typescript
// Frontend â†’ API â†’ KV
1. ç”¨æˆ¶ç™¼é€æ¶ˆæ¯
2. API å¾ KV è®€å–ç”¨æˆ¶è¨˜æ†¶ï¼ˆ5-20msï¼‰
3. çµ„åˆï¼šSystem Prompt + KV Memory + å°è©±æ­·å²
4. ç™¼é€çµ¦ LLMï¼ˆGemini/Claudeï¼‰
5. è¿”å› Megan çš„å›æ‡‰
6. å°‡å°è©±è¿½åŠ åˆ° Supabase conversations è¡¨
```

### 2ï¸âƒ£ å°è©±çµæŸå¾Œï¼ˆç•°æ­¥è™•ç†ï¼‰

```typescript
// åˆ¤æ–·æ˜¯å¦éœ€è¦æå–è¨˜æ†¶
if (messages.length >= 5 || hasImportantKeywords) {
  // å‰µå»ºæå–ä»»å‹™
  await createMemoryExtractionJob(userId, conversationId);
}

// èƒŒæ™¯ä»»å‹™ï¼ˆCloudflare Worker Cronï¼‰
async function processMemoryExtractionJobs() {
  const jobs = await getPendingJobs();

  for (const job of jobs) {
    // 1. è®€å–å°è©±å…§å®¹
    const conversation = await getConversation(job.conversation_id);

    // 2. ä½¿ç”¨ GPT æå–è¨˜æ†¶
    const memories = await extractMemoriesWithGPT(conversation);

    // 3. æ›´æ–° KVï¼ˆå¿«é€Ÿè¨˜æ†¶å±¤ï¼‰
    await updateKVMemory(job.user_id, memories);

    // 4. æ¨™è¨˜ä»»å‹™å®Œæˆ
    await markJobCompleted(job.id);
  }
}
```

### 3ï¸âƒ£ æ¯æ—¥æ‘˜è¦ç”Ÿæˆï¼ˆå®šæ™‚ä»»å‹™ï¼‰

```typescript
// æ¯å¤©å‡Œæ™¨ 2:00 é‹è¡Œï¼ˆCloudflare Worker Cronï¼‰
async function generateDailySummaries() {
  const yesterday = getYesterday();
  const users = await getActiveUsers(yesterday);

  for (const user of users) {
    // 1. è®€å–æ˜¨å¤©æ‰€æœ‰å°è©±
    const conversations = await getConversationsByDate(user.id, yesterday);

    // 2. ä½¿ç”¨ GPT ç”Ÿæˆæ¯æ—¥æ‘˜è¦
    const summary = await generateDailySummaryWithGPT(conversations);

    // 3. å„²å­˜åˆ° Supabase
    await saveDailySummary(user.id, yesterday, summary);

    // 4. å¦‚æœæœ‰é‡è¦æ›´æ–°ï¼Œåˆä½µåˆ° KV longterm
    if (summary.should_merge_to_longterm) {
      await mergeSummaryToLongterm(user.id, summary);
    }
  }
}
```

---

## ğŸ¨ éˆæ ¼ç®¡ç†å¾Œå° v1.0 å¯¦æ–½æ–¹æ¡ˆ

### æŠ€è¡“æ£§

- **Frontend**: Next.js 15 + React + Tailwind CSS
- **Backend**: Next.js API Routes + Supabase
- **KV Access**: Cloudflare API (é€šé Worker ä»£ç†)
- **Auth**: Supabase Authï¼ˆåªå…è¨± Waitin ç™»å…¥ï¼‰
- **Charts**: Recharts / Chart.js

### è·¯ç”±çµæ§‹

```
/admin
  /login                    # ç™»å…¥é 
  /dashboard                # å„€è¡¨æ¿
  /users                    # ç”¨æˆ¶åˆ—è¡¨
  /users/:userId            # ç”¨æˆ¶ç¸½è¦½
  /users/:userId/memories   # è¨˜æ†¶ç¸½è¦½
  /users/:userId/memories/:key  # è¨˜æ†¶è©³ç´°ç·¨è¼¯
  /users/:userId/conversations  # å°è©±ç´€éŒ„
  /users/:userId/summaries      # æ¯æ—¥æ‘˜è¦
  /settings                 # å…¨å±€è¨­å®š
```

---

## ğŸ“Š å…«å¤§é é¢è©³ç´°è¨­è¨ˆ

### 1ï¸âƒ£ ç™»å…¥é ï¼ˆ`/admin/login`ï¼‰

```tsx
// app/admin/login/page.tsx
export default function AdminLogin() {
  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50">
      <div className="flex items-center justify-center min-h-screen">
        <Card className="w-[400px]">
          <CardHeader>
            <h1 className="text-2xl font-bold">ToneSpirit Admin</h1>
            <p className="text-slate-500">v1.0</p>
          </CardHeader>
          <CardContent>
            <input type="email" placeholder="Email" />
            <input type="password" placeholder="Password" />
            <button>Login</button>
          </CardContent>
          <CardFooter>
            <p className="text-xs text-slate-400">Â© 2025 Superintelligence</p>
          </CardFooter>
        </Card>
      </div>
    </div>
  );
}
```

**æ¬Šé™æ§åˆ¶**ï¼š

```sql
-- Supabase RLS
create policy "åªå…è¨± Waitin ç™»å…¥å¾Œå°"
  on profiles for select
  using (auth.uid() = 'waitin-user-id');
```

---

### 2ï¸âƒ£ å„€è¡¨æ¿ï¼ˆ`/admin/dashboard`ï¼‰

**API Endpoints**:

```typescript
// app/api/admin/dashboard/route.ts
export async function GET() {
  const stats = {
    todayConversations: await getTodayConversationCount(),
    todayMemoryUpdates: await getTodayMemoryUpdateCount(),
    activeUsers: await getActiveUserCount(),
    avgPositiveEmotion: await getAvgPositiveEmotion(),
    recentUsers: await getRecentUsers(5),
    pendingReviews: await getPendingReviews()
  };

  return Response.json(stats);
}
```

**UI Components**:

```tsx
<Dashboard>
  <KPICards>
    <KPICard title="ä»Šæ—¥æ–°å¢å°è©±" value={stats.todayConversations} />
    <KPICard title="ä»Šæ—¥æ›´æ–°è¨˜æ†¶" value={stats.todayMemoryUpdates} />
    <KPICard title="æ´»èºç”¨æˆ¶" value={stats.activeUsers} />
    <KPICard title="å¹³å‡æ­£å‘æƒ…ç·’" value={`${stats.avgPositiveEmotion}%`} />
  </KPICards>

  <RecentUsers users={stats.recentUsers} />

  <PendingReviews reviews={stats.pendingReviews} />
</Dashboard>
```

---

### 3ï¸âƒ£ ç”¨æˆ¶åˆ—è¡¨é ï¼ˆ`/admin/users`ï¼‰

**API**:

```typescript
// app/api/admin/users/route.ts
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const search = searchParams.get('search');
  const status = searchParams.get('status');
  const page = parseInt(searchParams.get('page') || '1');

  const users = await supabase
    .from('profiles')
    .select(`
      *,
      conversations(count),
      user_memories(count)
    `)
    .ilike('nickname', `%${search}%`)
    .range((page - 1) * 20, page * 20 - 1);

  return Response.json(users);
}
```

**UI Table**:

```tsx
<UsersTable>
  <thead>
    <tr>
      <th>ç”¨æˆ¶ ID</th>
      <th>æš±ç¨±</th>
      <th>æœ€å¾Œå°è©±æ™‚é–“</th>
      <th>è¨˜æ†¶ç¸½é‡</th>
      <th>é»˜å¥‘ç­‰ç´š</th>
      <th>ç‹€æ…‹</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody>
    {users.map(user => (
      <tr key={user.id}>
        <td>{user.id.slice(0, 8)}</td>
        <td>{user.nickname}</td>
        <td>{formatDate(user.last_conversation)}</td>
        <td>{user.memory_count}</td>
        <td>{calculateBondLevel(user)}</td>
        <td>{user.status}</td>
        <td>
          <Link href={`/admin/users/${user.id}`}>æŸ¥çœ‹</Link>
        </td>
      </tr>
    ))}
  </tbody>
</UsersTable>
```

---

### 4ï¸âƒ£ ç”¨æˆ¶ç¸½è¦½é ï¼ˆ`/admin/users/:userId`ï¼‰

**API**:

```typescript
// app/api/admin/users/[userId]/overview/route.ts
export async function GET(
  request: Request,
  { params }: { params: { userId: string } }
) {
  const userId = params.userId;

  // å¾ KV è®€å–è¨˜æ†¶
  const kvMemories = await getKVMemories(userId);

  // å¾ Supabase è®€å–ç”¨æˆ¶è³‡æ–™
  const profile = await getProfile(userId);

  // å¾ Supabase è®€å–çµ±è¨ˆæ•¸æ“š
  const stats = await getUserStats(userId);

  return Response.json({
    profile,
    memories: kvMemories,
    stats
  });
}
```

**UI Sections**:

```tsx
<UserOverview>
  {/* A. åŸºæœ¬è³‡æ–™ */}
  <ProfileCard>
    <h2>{user.nickname}</h2>
    <p>å¹´é½¡: {user.estimated_age || 'æœªçŸ¥'}</p>
    <p>æ€§åˆ¥: {user.estimated_gender || 'æœªçŸ¥'}</p>
    <p>è·æ¥­: {user.estimated_occupation || 'æœªçŸ¥'}</p>
  </ProfileCard>

  {/* B. Megan çš„æ ¸å¿ƒç†è§£ */}
  <CoreUnderstanding>
    <h3>æ­¤äººæ˜¯æ€æ¨£çš„äººï¼Ÿ</h3>
    <p>{kvMemories.profile.personality_summary}</p>

    <h3>å¸¸å‡ºç¾çš„æƒ…ç·’æ¨¡å¼</h3>
    <p>{kvMemories.profile.emotion_patterns}</p>

    <h3>ä¾è³´ Megan çš„æ–¹å¼</h3>
    <p>{kvMemories.relationship.dependency_pattern}</p>
  </CoreUnderstanding>

  {/* C. åå¥½ */}
  <Preferences>
    <PreferenceItem>
      <label>å–œæ­¡çš„èªæ°£</label>
      <p>{kvMemories.preferences.preferred_tone}</p>
    </PreferenceItem>
    <PreferenceItem>
      <label>é¿å…çš„è©±é¡Œ</label>
      <p>{kvMemories.preferences.avoid_topics.join(', ')}</p>
    </PreferenceItem>
  </Preferences>

  {/* D. å¿«é€Ÿæ“ä½œ */}
  <QuickActions>
    <Button href={`/admin/users/${userId}/memories`}>æŸ¥çœ‹è¨˜æ†¶</Button>
    <Button href={`/admin/users/${userId}/conversations`}>æŸ¥çœ‹å°è©±</Button>
    <Button onClick={forceResummarize}>å¼·åˆ¶é‡æ–°æ‘˜è¦</Button>
  </QuickActions>
</UserOverview>
```

---

### 5ï¸âƒ£ è¨˜æ†¶ç¸½è¦½é ï¼ˆ`/admin/users/:userId/memories`ï¼‰

**API**:

```typescript
// app/api/admin/users/[userId]/memories/route.ts
export async function GET(
  request: Request,
  { params }: { params: { userId: string } }
) {
  const userId = params.userId;

  // å¾ Cloudflare KV è®€å–æ‰€æœ‰è¨˜æ†¶ keys
  const keys = [
    'profile',
    'preferences',
    'relationship',
    'longterm'
  ];

  const memories = await Promise.all(
    keys.map(async (key) => {
      const value = await KV.get(`user:${userId}:${key}`);
      const metadata = await KV.getWithMetadata(`user:${userId}:${key}`);

      return {
        key,
        size: new Blob([value]).size,
        lastUpdated: metadata.metadata?.lastUpdated,
        value: JSON.parse(value)
      };
    })
  );

  return Response.json({ memories });
}
```

**UI Table**:

```tsx
<MemoriesTable>
  <thead>
    <tr>
      <th>Key</th>
      <th>èªªæ˜</th>
      <th>å¤§å°</th>
      <th>æœ€å¾Œæ›´æ–°æ™‚é–“</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody>
    {memories.map(memory => (
      <tr key={memory.key}>
        <td><code>{memory.key}</code></td>
        <td>{getDescription(memory.key)}</td>
        <td>{formatBytes(memory.size)}</td>
        <td>{formatDate(memory.lastUpdated)}</td>
        <td>
          <Link href={`/admin/users/${userId}/memories/${memory.key}`}>
            æŸ¥çœ‹/ç·¨è¼¯
          </Link>
        </td>
      </tr>
    ))}
  </tbody>
</MemoriesTable>

<Actions>
  <Button onClick={exportAllMemories}>åŒ¯å‡ºå…¨éƒ¨è¨˜æ†¶ (JSON)</Button>
  <Button onClick={importMemories}>åŒ¯å…¥è¨˜æ†¶</Button>
</Actions>
```

---

### 6ï¸âƒ£ è¨˜æ†¶è©³ç´°é ï¼ˆ`/admin/users/:userId/memories/:key`ï¼‰

**API**:

```typescript
// app/api/admin/users/[userId]/memories/[key]/route.ts
export async function GET(
  request: Request,
  { params }: { params: { userId: string; key: string } }
) {
  const { userId, key } = params;

  const memory = await KV.getWithMetadata(`user:${userId}:${key}`);

  return Response.json({
    key,
    value: JSON.parse(memory.value),
    metadata: memory.metadata
  });
}

export async function PUT(
  request: Request,
  { params }: { params: { userId: string; key: string } }
) {
  const { userId, key } = params;
  const body = await request.json();

  await KV.put(
    `user:${userId}:${key}`,
    JSON.stringify(body.value),
    {
      metadata: {
        lastUpdated: new Date().toISOString(),
        updatedBy: 'admin'
      }
    }
  );

  return Response.json({ success: true });
}
```

**UI**:

```tsx
<MemoryDetail>
  {/* è³‡è¨Šåˆ— */}
  <InfoBar>
    <InfoItem label="Key" value={memory.key} />
    <InfoItem label="æœ€å¾Œæ›´æ–°" value={memory.metadata.lastUpdated} />
    <InfoItem label="å­—æ•¸" value={getWordCount(memory.value)} />
    <InfoItem label="å¤§å°" value={formatBytes(memory.size)} />
  </InfoBar>

  {/* è¨˜æ†¶å…§å®¹ç·¨è¼¯å™¨ */}
  <Editor>
    <JSONEditor
      value={memory.value}
      onChange={handleChange}
      readOnly={false}
    />
  </Editor>

  {/* æ“ä½œæŒ‰éˆ• */}
  <Actions>
    <Button onClick={saveChanges}>å„²å­˜æ›´æ–°</Button>
    <Button onClick={cancelChanges}>å–æ¶ˆä¿®æ”¹</Button>
    <Button onClick={showDiff}>Diff èˆŠç‰ˆ</Button>
    <Button onClick={deleteMemory} danger>åˆªé™¤</Button>
  </Actions>
</MemoryDetail>
```

---

### 7ï¸âƒ£ å°è©±ç´€éŒ„é ï¼ˆ`/admin/users/:userId/conversations`ï¼‰

**API**:

```typescript
// app/api/admin/users/[userId]/conversations/route.ts
export async function GET(
  request: Request,
  { params }: { params: { userId: string } }
) {
  const { searchParams } = new URL(request.url);
  const startDate = searchParams.get('start');
  const endDate = searchParams.get('end');
  const keyword = searchParams.get('keyword');

  const conversations = await supabase
    .from('conversations')
    .select('*')
    .eq('user_id', params.userId)
    .gte('started_at', startDate)
    .lte('ended_at', endDate)
    .order('started_at', { ascending: false });

  return Response.json({ conversations });
}
```

**UI**:

```tsx
<ConversationLog>
  {/* æœå°‹å™¨ */}
  <SearchBar>
    <DateRangePicker onChange={setDateRange} />
    <Input placeholder="æœå°‹é—œéµå­—..." onChange={setKeyword} />
    <Select onChange={setEmotionFilter}>
      <option value="all">æ‰€æœ‰æƒ…ç·’</option>
      <option value="happy">å¿«æ¨‚</option>
      <option value="sad">æ‚²å‚·</option>
      <option value="anxious">ç„¦æ…®</option>
    </Select>
  </SearchBar>

  {/* å°è©±ç´€éŒ„ */}
  <MessageList>
    {messages.map(msg => (
      <Message
        key={msg.id}
        role={msg.role}
        content={msg.content}
        emotion={msg.emotion}
        timestamp={msg.timestamp}
      />
    ))}
  </MessageList>

  {/* åŒ¯å‡º */}
  <ExportButton onClick={exportConversations}>
    ä¸‹è¼‰å…¨éƒ¨å°è©± (TXT/JSON)
  </ExportButton>
</ConversationLog>
```

**Message çµ„ä»¶ï¼ˆå¸¶æƒ…ç·’ä¸Šè‰²ï¼‰**:

```tsx
function Message({ role, content, emotion, timestamp }) {
  const emotionColors = {
    happy: 'bg-green-50 border-green-200',
    calm: 'bg-blue-50 border-blue-200',
    anxious: 'bg-yellow-50 border-yellow-200',
    sad: 'bg-gray-50 border-gray-200',
    angry: 'bg-red-50 border-red-200'
  };

  return (
    <div className={`p-4 rounded-lg ${emotionColors[emotion]}`}>
      <div className="flex justify-between">
        <strong>{role === 'user' ? user.nickname : 'Megan'}</strong>
        <span className="text-xs text-slate-500">{formatTime(timestamp)}</span>
      </div>
      <p>{content}</p>
      {emotion && <Badge>{emotion}</Badge>}
    </div>
  );
}
```

---

### 8ï¸âƒ£ æ¯æ—¥æ‘˜è¦é ï¼ˆ`/admin/users/:userId/summaries`ï¼‰

**API**:

```typescript
// app/api/admin/users/[userId]/summaries/route.ts
export async function GET(
  request: Request,
  { params }: { params: { userId: string } }
) {
  const { searchParams } = new URL(request.url);
  const date = searchParams.get('date') || getTodayDate();

  const summary = await supabase
    .from('daily_summaries')
    .select('*')
    .eq('user_id', params.userId)
    .eq('date', date)
    .single();

  return Response.json({ summary });
}
```

**UI**:

```tsx
<DailySummary>
  {/* æ—¥æœŸé¸æ“‡å™¨ */}
  <DatePicker value={selectedDate} onChange={setSelectedDate} />

  {/* æƒ…ç·’è¶¨å‹¢åœ– */}
  <EmotionTrend>
    <LineChart data={summary.emotion_trend}>
      <XAxis dataKey="time" />
      <YAxis />
      <Line type="monotone" dataKey="happiness" stroke="#10b981" />
      <Line type="monotone" dataKey="anxiety" stroke="#f59e0b" />
    </LineChart>
  </EmotionTrend>

  {/* ä»Šæ—¥ Megan å­¸åˆ°çš„æ–°æ±è¥¿ */}
  <NewLearnings>
    <h3>ğŸ§  ä»Šæ—¥ Megan å­¸åˆ°çš„æ–°æ±è¥¿</h3>
    <ul>
      {summary.new_learnings.map((learning, i) => (
        <li key={i}>{learning}</li>
      ))}
    </ul>
  </NewLearnings>

  {/* é—œä¿‚æ›´æ–° */}
  <RelationshipUpdate>
    <h3>ğŸ’ ä»Šæ—¥é—œä¿‚æ›´æ–°</h3>
    <p>{summary.relationship_update}</p>
  </RelationshipUpdate>

  {/* æ–°åå¥½ */}
  <NewPreferences>
    <h3>âœ¨ ä»Šæ—¥æ–°åå¥½</h3>
    <ul>
      {summary.new_preferences.map((pref, i) => (
        <li key={i}>{pref}</li>
      ))}
    </ul>
  </NewPreferences>

  {/* æ“ä½œæŒ‰éˆ• */}
  <Actions>
    <Button onClick={mergeToLongterm}>è¦†å¯«åˆ° longterm</Button>
    <Button onClick={ignoreToday}>åŠ å…¥ ignored</Button>
    <Button onClick={manualEdit}>ä¿®æ”¹å¾Œæ‰‹å‹•å¯«å…¥</Button>
  </Actions>
</DailySummary>
```

---

## ğŸ”§ å…¨å±€è¨­å®šé ï¼ˆ`/admin/settings`ï¼‰

```tsx
<Settings>
  {/* Megan System Prompt */}
  <Section>
    <h2>Megan System Promptï¼ˆä¸»éˆæ ¼ï¼‰</h2>
    <Textarea
      value={systemPrompt}
      onChange={setSystemPrompt}
      rows={20}
    />
    <Button onClick={saveSystemPrompt}>å„²å­˜</Button>
  </Section>

  {/* æ¯æ—¥ç²¾ç…‰è¦å‰‡ */}
  <Section>
    <h2>æ¯æ—¥ç²¾ç…‰è¦å‰‡</h2>
    <Input label="æœ€å¤§å­—æ•¸" value={maxWords} onChange={setMaxWords} />
    <Input label="åˆ†æ®µæ•¸" value={paragraphs} onChange={setParagraphs} />
  </Section>

  {/* KV æ¸¬è©¦å·¥å…· */}
  <Section>
    <h2>KV å‘½åç©ºé–“æ¸¬è©¦å·¥å…·</h2>
    <Input placeholder="Key" value={testKey} onChange={setTestKey} />
    <Button onClick={kvGet}>GET</Button>
    <Textarea placeholder="Value" value={testValue} onChange={setTestValue} />
    <Button onClick={kvPut}>PUT</Button>
  </Section>

  {/* API Key è¨­å®š */}
  <Section>
    <h2>API Key è¨­å®š</h2>
    <Input label="Cloudflare API Token" type="password" />
    <Input label="OpenAI API Key" type="password" />
  </Section>
</Settings>
```

---

## ğŸš€ å¯¦æ–½æ­¥é©Ÿï¼ˆPhase by Phaseï¼‰

### Phase 1: åŸºç¤æ¶æ§‹ï¼ˆWeek 1ï¼‰

- [ ] å»ºç«‹ Supabase æ•¸æ“šåº«è¡¨
- [ ] è¨­ç½® Cloudflare KV å‘½åç©ºé–“
- [ ] å¯¦ç¾ Cloudflare Worker API
- [ ] å»ºç«‹ Admin ç™»å…¥é é¢

### Phase 2: è¨˜æ†¶ç³»çµ±ï¼ˆWeek 2-3ï¼‰

- [ ] å¯¦ç¾è¨˜æ†¶è¼‰å…¥åŠŸèƒ½ï¼ˆKV â†’ API â†’ Frontendï¼‰
- [ ] å¯¦ç¾è¨˜æ†¶æå–åŠŸèƒ½ï¼ˆGPT åˆ†æ â†’ KVï¼‰
- [ ] å¯¦ç¾å°è©±å„²å­˜åŠŸèƒ½ï¼ˆFrontend â†’ Supabaseï¼‰

### Phase 3: ç®¡ç†å¾Œå°ï¼ˆWeek 3-4ï¼‰

- [ ] å„€è¡¨æ¿é é¢
- [ ] ç”¨æˆ¶åˆ—è¡¨ + ç¸½è¦½é é¢
- [ ] è¨˜æ†¶ç·¨è¼¯é é¢
- [ ] å°è©±ç´€éŒ„é é¢

### Phase 4: æ¯æ—¥æ‘˜è¦ï¼ˆWeek 5ï¼‰

- [ ] æ¯æ—¥æ‘˜è¦ç”Ÿæˆ Cron Job
- [ ] æ¯æ—¥æ‘˜è¦æŸ¥çœ‹é é¢
- [ ] æ‰‹å‹•åˆä½µåˆ° longterm åŠŸèƒ½

### Phase 5: å„ªåŒ–èˆ‡æ¸¬è©¦ï¼ˆWeek 6ï¼‰

- [ ] æ€§èƒ½å„ªåŒ–
- [ ] UI/UX å„ªåŒ–
- [ ] æ¸¬è©¦èˆ‡ Bug ä¿®å¾©

---

## ğŸ’° æˆæœ¬ä¼°ç®—

### Cloudflareï¼ˆå…è²» / Paidï¼‰

- **KV Storage**: å…è²» 1GBï¼Œæ¯å¤© 100K readsï¼Œ1K writes
- **Workers**: å…è²» 100K requests/day
- **Cron Jobs**: å…è²»

### Supabaseï¼ˆå…è²» / Proï¼‰

- **Free Plan**: 500MB æ•¸æ“šåº«ï¼Œ2GB æµé‡/æœˆ
- **Pro Plan**: $25/æœˆï¼Œ8GB æ•¸æ“šåº«ï¼Œ250GB æµé‡

### é è¨ˆæˆæœ¬

- **Phase 1-2**ï¼ˆæ¸¬è©¦éšæ®µï¼‰: $0
- **Phase 3-5**ï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰: ~$25/æœˆï¼ˆSupabase Proï¼‰

---

## âœ… ç¸½çµ

é€™å€‹æ•´åˆç³»çµ±çµåˆäº†ï¼š

1. âœ… **ä½ çš„éˆæ ¼ç®¡ç†å¾Œå° v1.0**ï¼ˆ8 å¤§é é¢å®Œæ•´è¨­è¨ˆï¼‰
2. âœ… **æˆ‘çš„è¨˜æ†¶ç³»çµ±æ¶æ§‹**ï¼ˆKV + Supabase æ··åˆå„²å­˜ï¼‰
3. âœ… **å®Œæ•´çš„æ•¸æ“šæµç¨‹**ï¼ˆå¯¦æ™‚ + ç•°æ­¥ + å®šæ™‚ä»»å‹™ï¼‰
4. âœ… **å¯æ“´å±•æ€§**ï¼ˆæ”¯æ´å¤šç”¨æˆ¶ã€å¤š AI éˆæ ¼ï¼‰

**ä¸‹ä¸€æ­¥**ï¼šä½ æƒ³å…ˆå¯¦æ–½å“ªå€‹ Phaseï¼Ÿæˆ‘å»ºè­°å¾ Phase 1 é–‹å§‹ï¼Œå…ˆå»ºç«‹åŸºç¤æ¶æ§‹ã€‚
